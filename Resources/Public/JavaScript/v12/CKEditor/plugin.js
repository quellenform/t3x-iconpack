/*
 * This file is part of the "iconpack" Extension for TYPO3 CMS.
 *
 * Conceived and written by Stephan Kellermayr
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 */
import{Plugin,Command}from'@ckeditor/ckeditor5-core';import{Widget,toWidget}from'@ckeditor/ckeditor5-widget';import{ButtonView}from'@ckeditor/ckeditor5-ui';import{DomEventObserver}from'@ckeditor/ckeditor5-engine';import IconpackModal from'@quellenform/iconpack-modal.js';const iconpackIcon='<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><g stroke="#000" stroke-linecap="round" stroke-linejoin="bevel" stroke-width=".295"><path d="m0.2628 1.9151 6.6836 3.9405 12.791-2.9519-8.6056-2.7421z" fill="#a5a6a5"/><path d="m0.2628 1.9151 1.2416 11.367 5.8931 6.5566-0.45127-13.983z" fill="#8c8d8c"/><path d="m19.737 2.9037-1.4892 12.311-10.851 4.6234-0.45127-13.983z" fill="#bec0be" style="paint-order:normal"/></g></svg>';class DoubleClickObserver extends DomEventObserver{get domEventType(){return'dblclick'}onDomEvent(e){this.fire('dblclick',e)}}export class Iconpack extends Plugin{static get requires(){return[IconpackCommand,IconpackEditing,IconpackUI]}};Iconpack.pluginName='Iconpack';export class IconpackEditing extends Plugin{constructor(){super(...arguments),this.attributes=null}static get requires(){return[Widget]}init(){this.attributes=['data-iconfig','name','id','class','style','alt','title'],this._defineSchema(),this._defineWebfontConverters(),this._defineImageConverters(),this.editor.commands.add('iconpack',new IconpackCommand(this.editor))}_defineSchema(){const e=this.editor.model.schema;e.register('iconpackWebfont',{allowAttributes:Object.values(this.attributes),allowAttributesOf:'$text',allowWhere:'$text',isInline:!0,isObject:!0,isLimit:!0}),e.register('iconpackImage',{allowAttributes:Object.values(this.attributes).concat('src'),allowAttributesOf:'$text',allowWhere:'$text',isInline:!0,isObject:!0,isLimit:!0}),this.editor.editing.view.domConverter.inlineObjectElements.push('iconpackWebfont'),this.editor.editing.view.domConverter.inlineObjectElements.push('iconpackImage')}_defineWebfontConverters(){const e=this.editor.conversion;e.for('upcast').elementToElement({view:{name:'span',attributes:['data-iconfig']},model:(e,{writer:t})=>t.createElement('iconpackWebfont',e.getAttributes()),converterPriority:'highest'}),e.for('dataDowncast').elementToElement({model:'iconpackWebfont',view:(e,{writer:t})=>t.createEmptyElement('span',this._getViewAttributes(e))}),e.for('editingDowncast').elementToElement({model:'iconpackWebfont',view:(e,{writer:t})=>{const i=t.createContainerElement('span',this._getViewAttributes(e)),n=t.createContainerElement('data');return n._appendChild(i),n._addClass('ck-widget-iconpack'),toWidget(n,t,{label:'Iconpack widget'})}})}_defineImageConverters(){const e=this.editor.conversion;e.for('upcast').elementToElement({view:{name:'img',attributes:['data-iconfig']},model:(e,{writer:t})=>t.createElement('iconpackImage',e.getAttributes()),converterPriority:'highest'}),e.for('dataDowncast').elementToElement({model:'iconpackImage',view:(e,{writer:t})=>(e._removeAttribute('htmlImgAttributes'),e._removeAttribute('loading'),t.createEmptyElement('img',this._getViewAttributes(e,'src')))}),e.for('editingDowncast').elementToElement({model:'iconpackImage',view:(e,{writer:t})=>{const i=t.createContainerElement('img',this._getViewAttributes(e,'src')),n=t.createContainerElement('data');return n._appendChild(i),n._addClass('ck-widget-iconpack'),toWidget(n,t,{label:'Iconpack widget'})}})}_getViewAttributes(e,t){const i={};let n=this.attributes;return t&&(n=Object.values(this.attributes).concat('src')),n.forEach(t=>{const n=e.getAttribute(t);n&&''!=n&&(i[t]=n)}),i}};export class IconpackCommand extends Command{execute(){const e=this.editor.model.document.selection;this.editor.model.change(t=>{const i=e.getSelectedElement();let n=null;i&&(n=i.getAttribute('data-iconfig'));const o={fieldType:'rte',iconfigString:n};IconpackModal.openIconpackModal(TYPO3.lang['js.label.iconRte'],o,this._addIconToRte.bind(this),this._removeIconFromRte.bind(this))})}refresh(){const e=this.editor.model,t=e.document.selection,i=e.schema.findAllowedParent(t.getFirstPosition(),'iconpackWebfont');this.isEnabled=null!==i}_addIconToRte(e,t){if(t){const e=this._getSelectionParent(),i={};if(e&&'a'===e.name){if(e.hasAttribute('href')&&(i.href=e.getAttribute('href')),e.hasAttribute('target')&&(i.target=e.getAttribute('target')),e.hasAttribute('title')&&(i.title=e.getAttribute('title')),e.hasClass()){let t=[...e.getClassNames()];0!=(t=t.filter(e=>'ck-link_selected'!=e).map(e=>e)).length&&(i.class=Object.values(t).join(' '))}let n='';Object.entries(i).forEach(([e,t])=>{n+=' '+e+'="'+t+'"'}),t='<a'+n+'>'+t+'</a>'}const n=this.editor.data.processor.toView(t),o=this.editor.data.toModel(n);this.editor.model.insertContent(o)}}_getSelectionParent(){return this.editor.editing.view.document.selection.focus.getAncestors().reverse().find(e=>e.is('element'))}_removeIconFromRte(){const e=this.editor.model.document.selection.getFirstRange();this.editor.model.change(t=>{t.remove(e)})}};export class IconpackUI extends Plugin{init(){const e=this.editor,t=e.t;e.ui.componentFactory.add('iconpack',i=>{const n=e.commands.get('iconpack'),o=new ButtonView(i);return o.set({withText:!0,tooltip:t('Insert Icon'),icon:iconpackIcon,isToggleable:!0}),o.bind('isOn','isEnabled').to(n,'value','isEnabled'),this.listenTo(o,'execute',()=>{e.execute('iconpack')}),o});const i=e.editing.view,n=i.document;i.addObserver(DoubleClickObserver),e.listenTo(n,'dblclick',(t,i)=>{if(i.target.parent){const t=e.editing.mapper.toModelElement(i.target.parent);!t||void 0===t.name||'iconpackWebfont'!==t.name&&'iconpackImage'!==t.name||e.execute('iconpack')}})}};export default Iconpack;

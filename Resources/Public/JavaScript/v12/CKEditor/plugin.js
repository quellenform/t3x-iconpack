/*
 * This file is part of the "iconpack" Extension for TYPO3 CMS.
 *
 * Conceived and written by Stephan Kellermayr
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 */
import{Plugin,Command}from'@ckeditor/ckeditor5-core';import{Widget,toWidget}from'@ckeditor/ckeditor5-widget';import{ButtonView}from'@ckeditor/ckeditor5-ui';import{DomEventObserver}from'@ckeditor/ckeditor5-engine';import IconpackModal from'@quellenform/iconpack-modal.js';const iconpackIcon='<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><g stroke="#000" stroke-linecap="round" stroke-linejoin="bevel" stroke-width=".295"><path d="m0.2628 1.9151 6.6836 3.9405 12.791-2.9519-8.6056-2.7421z" fill="#a5a6a5"/><path d="m0.2628 1.9151 1.2416 11.367 5.8931 6.5566-0.45127-13.983z" fill="#8c8d8c"/><path d="m19.737 2.9037-1.4892 12.311-10.851 4.6234-0.45127-13.983z" fill="#bec0be" style="paint-order:normal"/></g></svg>';class DoubleClickObserver extends DomEventObserver{get domEventType(){return'dblclick'}onDomEvent(t){this.fire('dblclick',t)}}export class Iconpack extends Plugin{static get requires(){return[IconpackCommand,IconpackEditing,IconpackUI]}};Iconpack.pluginName='Iconpack';export class IconpackEditing extends Plugin{constructor(){super(...arguments),this.svgElements=null,this.attributes=null,this.svgGlobalAttributes=null,this.svgPresentationAttributes=null}static get requires(){return[Widget]}init(){this.svgElements=['use','image','title','desc','defs','linearGradient','radialGradient','stop','g','line','path','polyline','polygon','rect','circle','ellipse'],this.attributes=['data-iconfig','name','id','class','style','alt','title'],this.svgGlobalAttributes=['class','id','title'],this.svgPresentationAttributes=['clip-path','clip-rule','color','display','fill','fill-opacity','fill-rule','filter','mask','opacity','shape-rendering','stroke','stroke-dasharray','stroke-dashoffset','stroke-linecap','stroke-linejoin','stroke-miterlimit','stroke-opacity','stroke-width','transform','visibility'],this._defineSchema(),this._defineWebfontConverters(),this._defineImageConverters(),this._defineInlineSvgConverters(),this.editor.commands.add('iconpack',new IconpackCommand(this.editor))}_defineSchema(){const t=this.editor.model.schema;t.register('iconpackWebfont',{allowAttributes:Object.values(this.attributes),allowAttributesOf:'$text',allowWhere:'$text',isInline:!0,isObject:!0,isLimit:!0}),t.register('iconpackImage',{allowAttributes:Object.values(this.attributes).concat('src'),allowAttributesOf:'$text',allowWhere:'$text',isInline:!0,isObject:!0,isLimit:!0}),t.register('iconpackSvg',{allowAttributes:this._getAllowedAttributes(Object.values(this.attributes).concat(['width','height','fill','viewBox','xmlns','xmlns:xlink']),!0,!0),allowAttributesOf:'$text',allowWhere:'$text',isInline:!0,isObject:!0,isLimit:!0,allowChildren:['svgUse','svgImage','svgTitle','svgDesc','svgDefs','svgLinearGradient','svgRadialGradient','svgStop','svgG','svgLine','svgPath','svgPolyline','svgPolygon','svgRect','svgCircle','svgEllipse']}),t.register('svgUse',{allowIn:['iconpackSvg','svgG'],allowAttributes:this._getAllowedAttributes(['href','xlink:href','x','y','width','height'],!0,!0)}),t.register('svgImage',{allowIn:['iconpackSvg','svgG'],allowAttributes:this._getAllowedAttributes(['href','x','y','width','height','preserveAspectRatio'])}),t.register('svgTitle',{allowIn:['iconpackSvg','svgG'],allowAttributes:this._getAllowedAttributes(['id'])}),t.register('svgDesc',{allowIn:['iconpackSvg','svgG'],allowAttributes:this._getAllowedAttributes(['id'])}),t.register('svgDefs',{allowIn:['iconpackSvg','svgG'],allowAttributes:this._getAllowedAttributes([],!0,!0)}),t.register('svgLinearGradient',{allowIn:['iconpackSvg','svgDefs'],allowChildren:['svgStop'],allowAttributes:this._getAllowedAttributes(['gradientUnits','gradientTransform','spreadMethod','x1','x2','y1','y2'],!0,!0)}),t.register('svgRadialGradient',{allowIn:['iconpackSvg','svgDefs'],allowChildren:['svgStop'],allowAttributes:this._getAllowedAttributes(['gradientUnits','gradientTransform','spreadMethod','cx','cy','fr','fx','fy','r'],!0,!0)}),t.register('svgStop',{allowIn:['svgLinearGradient','svgRadialGradient'],allowAttributes:this._getAllowedAttributes(['stop-color','stop-opacity','offset'],!0,!0)}),t.register('svgG',{allowIn:'iconpackSvg',allowContentOf:'iconpackSvg',allowAttributes:this._getAllowedAttributes([],!0,!0)}),t.register('svgLine',{allowIn:['iconpackSvg','svgG','svgDefs'],allowAttributes:this._getAllowedAttributes(['x1','y1','x2','y2'],!0)}),t.register('svgPath',{allowIn:['iconpackSvg','svgG','svgDefs'],isLimit:!0,isInline:!0,isObject:!0,allowAttributes:this._getAllowedAttributes(['d','style'],!0)}),t.register('svgPolyline',{allowIn:['iconpackSvg','svgG','svgDefs'],allowAttributes:this._getAllowedAttributes(['points'],!0)}),t.register('svgPolygon',{allowIn:['iconpackSvg','svgG','svgDefs'],allowAttributes:this._getAllowedAttributes(['points'],!0)}),t.register('svgRect',{allowIn:['iconpackSvg','svgG','svgDefs'],allowAttributes:this._getAllowedAttributes(['width','height','x','y','rx','ry'],!0)}),t.register('svgCircle',{allowIn:['iconpackSvg','svgG','svgDefs'],allowAttributes:this._getAllowedAttributes(['cx','cy','r'],!0)}),t.register('svgEllipse',{allowIn:['iconpackSvg','svgG','svgDefs'],allowAttributes:this._getAllowedAttributes(['cx','cy','rx','ry'],!0)}),this.editor.editing.view.domConverter.inlineObjectElements.push('iconpackWebfont'),this.editor.editing.view.domConverter.inlineObjectElements.push('iconpackImage'),this.editor.editing.view.domConverter.inlineObjectElements.push('iconpackSvg')}_defineWebfontConverters(){const t=this.editor.conversion;t.for('upcast').elementToElement({view:{name:'span',attributes:['data-iconfig']},model:(t,{writer:e})=>e.createElement('iconpackWebfont',t.getAttributes()),converterPriority:'highest'}),t.for('dataDowncast').elementToElement({model:'iconpackWebfont',view:(t,{writer:e})=>e.createEmptyElement('span',this._getViewAttributes(t))}),t.for('editingDowncast').elementToElement({model:'iconpackWebfont',view:(t,{writer:e})=>{const i=e.createContainerElement('span',this._getViewAttributes(t)),s=e.createContainerElement('data');return s._appendChild(i),s._addClass('ck-widget-iconpack'),toWidget(s,e,{label:'Iconpack widget'})}})}_defineImageConverters(){const t=this.editor.conversion;t.for('upcast').elementToElement({view:{name:'img',attributes:['data-iconfig']},model:(t,{writer:e})=>e.createElement('iconpackImage',t.getAttributes()),converterPriority:'highest'}),t.for('dataDowncast').elementToElement({model:'iconpackImage',view:(t,{writer:e})=>(t._removeAttribute('htmlImgAttributes'),t._removeAttribute('loading'),e.createEmptyElement('img',this._getViewAttributes(t,['src'])))}),t.for('editingDowncast').elementToElement({model:'iconpackImage',view:(t,{writer:e})=>{const i=e.createContainerElement('img',this._getViewAttributes(t,['src'])),s=e.createContainerElement('data');return s._appendChild(i),s._addClass('ck-widget-iconpack'),toWidget(s,e,{label:'Iconpack widget'})}})}_defineInlineSvgConverters(){const t=this.editor.conversion;t.for('upcast').elementToElement({view:{name:'svg',attributes:['data-iconfig']},model:(t,{writer:e})=>e.createElement('iconpackSvg',t.getAttributes()),converterPriority:'highest'}),t.for('dataDowncast').elementToElement({model:'iconpackSvg',view:(t,{writer:e,consumable:i})=>{t._removeAttribute('htmlImgAttributes');for(const{item:e}of this.editor.model.createRangeIn(t))i.consume(e,'insert');const s=this._childrenToHtml(t.getChildren()),o=this._getAllowedAttributes(['width','height','fill','viewBox','xmlns','xmlns:xlink'],!0,!0);return e.createRawElement('svg',this._getViewAttributes(t,o),function(t){t.innerHTML=s})},converterPriority:'highest'}),t.for('editingDowncast').elementToElement({model:'iconpackSvg',view:(t,{writer:e,consumable:i})=>{t._removeAttribute('htmlImgAttributes');for(const{item:e}of this.editor.model.createRangeIn(t))i.consume(e,'insert');const s=this._childrenToHtml(t.getChildren()),o=this._getAllowedAttributes(['width','height','fill','viewBox','xmlns','xmlns:xlink'],!0,!0);let n=e.createRawElement('svg',this._getViewAttributes(t,o),function(t){t.innerHTML=s});const r=e.createContainerElement('data');return r._appendChild(n),r._addClass('ck-widget-iconpack'),toWidget(r,e,{label:'Iconpack widget'})},converterPriority:'highest'});for(const e of this.svgElements)t.for('upcast').elementToElement({view:e,model:(t,{writer:i})=>i.createElement('svg'+this._capitalizeFirstLetter(e),t.getAttributes())})}_childrenToHtml(t){let e='';for(const i of t){let t=i.name.toString().replace('svg','').toLowerCase(),s=i.getAttributes(),o='';for(const[t,e]of s)o+=' '+t+'="'+e+'"';if(i.childCount>0){e+='<'+t+o+'>'+this._childrenToHtml(i.getChildren())+'</'+t+'>'}else e+='<'+t+o+' />'}return e}_getViewAttributes(t,e){const i={};let s=this.attributes;return e&&(s=Object.values(this.attributes).concat(Object.values(e))),s.forEach(e=>{const s=t.getAttribute(e);s&&''!=s&&(i[e]=s)}),i}_getAllowedAttributes(t,e=!1,i=!1){return i&&(t=Object.values(this.svgGlobalAttributes).concat(t)),e&&(t=Object.values(this.svgPresentationAttributes).concat(t)),t}_capitalizeFirstLetter(t){return String(t).charAt(0).toUpperCase()+String(t).slice(1)}};export class IconpackCommand extends Command{execute(){const t=this.editor.model.document.selection;this.editor.model.change(e=>{const i=t.getSelectedElement();let s=null;i&&(s=i.getAttribute('data-iconfig'));const o={fieldType:'rte',iconfigString:s};IconpackModal.openIconpackModal(TYPO3.lang['js.label.iconRte'],o,this._addIconToRte.bind(this),this._removeIconFromRte.bind(this))})}refresh(){const t=this.editor.model,e=t.document.selection,i=t.schema.findAllowedParent(e.getFirstPosition(),'iconpackWebfont');this.isEnabled=null!==i}_addIconToRte(t,e){if(e){const t=this._getSelectionParent(),i={};if(t&&'a'===t.name){if(t.hasAttribute('href')&&(i.href=t.getAttribute('href')),t.hasAttribute('target')&&(i.target=t.getAttribute('target')),t.hasAttribute('title')&&(i.title=t.getAttribute('title')),t.hasClass()){let e=[...t.getClassNames()];0!=(e=e.filter(t=>'ck-link_selected'!=t).map(t=>t)).length&&(i.class=Object.values(e).join(' '))}let s='';Object.entries(i).forEach(([t,e])=>{s+=' '+t+'="'+e+'"'}),e='<a'+s+'>'+e+'</a>'}const s=this.editor.data.processor.toView(e),o=this.editor.data.toModel(s);this.editor.model.insertContent(o)}}_getSelectionParent(){return this.editor.editing.view.document.selection.focus.getAncestors().reverse().find(t=>t.is('element'))}_removeIconFromRte(){const t=this.editor.model.document.selection.getFirstRange();this.editor.model.change(e=>{e.remove(t)})}};export class IconpackUI extends Plugin{init(){const t=this.editor,e=t.t;t.ui.componentFactory.add('iconpack',i=>{const s=t.commands.get('iconpack'),o=new ButtonView(i);return o.set({withText:!0,tooltip:e('Insert Icon'),icon:iconpackIcon,isToggleable:!0}),o.bind('isOn','isEnabled').to(s,'value','isEnabled'),this.listenTo(o,'execute',()=>{t.execute('iconpack')}),o});const i=t.editing.view,s=i.document;i.addObserver(DoubleClickObserver),t.listenTo(s,'dblclick',(e,i)=>{if(i.target.parent){const e=t.editing.mapper.toModelElement(i.target.parent);!e||void 0===e.name||'iconpackWebfont'!==e.name&&'iconpackImage'!==e.name&&'iconpackSvg'!==e.name||t.execute('iconpack')}})}};export default Iconpack;
